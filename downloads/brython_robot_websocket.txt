from browser import document, html, timer, bind, websocket

# æ¯å€‹æ ¼å­çš„åƒç´ å¤§å°
CELL_SIZE = 40

# ç‰†å£åšåº¦ï¼Œç”¨æ–¼åœ–ç‰‡ä½ç½®èª¿æ•´
WALL_THICKNESS = 6

# ç‰†å£èˆ‡æ©Ÿå™¨äººåœ–ç‰‡çš„ä¾†æºè·¯å¾‘
IMG_PATH = "https://mde.tw/cp2025/reeborg/src/images/"

# --- WebSocket ADDITION ---
# Replace with your actual WebSocket server address
WS_SERVER_URL = "ws://localhost:8765"

try:
    ws = websocket.WebSocket(WS_SERVER_URL)

    @ws.bind("open")
    def on_open(evt):
        print("WebSocket connection opened")

    @ws.bind("message")
    def on_message(evt):
        data = evt.data
        print(f"ğŸ“¨ Received from WebSocket: {data}")
        if data == "move":
            r.move(1)
        elif data == "turn":
            r.turn_left()

    @ws.bind("close")
    def on_close(evt):
        print("WebSocket closed")

    @ws.bind("error")
    def on_error(evt):
        print("WebSocket error:", evt)

except Exception as e:
    print("WebSocket connection failed:", e)

# --- World / Robot classes (no change) ---
# [... YOUR EXISTING World and AnimatedRobot classes go here ...]

# --- ä¸»ç¨‹å¼ï¼šå»ºç«‹åœ°åœ–èˆ‡æ©Ÿå™¨äºº ---
w = World(10, 10)
w.robot(1, 1)
r = AnimatedRobot(w, 1, 1)

# --- Local keyboard control (still supported) ---
@bind(document, "keydown")
def keydown(evt):
    if evt.key == "j":
        r.move(1)
        # --- WebSocket ADDITION ---
        if ws and ws.readyState == 1:
            ws.send("move")
    elif evt.key == "i":
        r.turn_left()
        # --- WebSocket ADDITION ---
        if ws and ws.readyState == 1:
            ws.send("turn")

# --- Local button control ---
@bind(document["move_button"], "click")
def move_click(evt):
    r.move(1)
    if ws and ws.readyState == 1:
        ws.send("move")

@bind(document["turn_button"], "click")
def turn_click(evt):
    r.turn_left()
    if ws and ws.readyState == 1:
        ws.send("turn")

# åˆå§‹è‡ªå‹•å·¡é‚è·¯ç·šï¼ˆå¯ç§»é™¤ï¼‰
r.move(9)
r.turn_left()
r.move(9)
r.turn_left()
r.move(9)
r.turn_left()
r.move(9)
